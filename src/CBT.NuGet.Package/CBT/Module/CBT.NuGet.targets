<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetAdd" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetConfig" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetList" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetPack" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetPush" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetRestore" />
  <UsingTask AssemblyFile="$(CBTNuGetTasksAssemblyPath)" TaskName="CBT.NuGet.Tasks.NuGetSetApiKey" />

  <Target Name="RestoreNuGetPackages"
    Condition=" '$(CBTEnablePackageRestore)' == 'true' And '$(BuildingInsideVisualStudio)' != 'true' "
    DependsOnTargets="_CheckForCBTNuGetPackagesRestoredMarker;$(RestoreNuGetPackagesDependsOn)"
    Inputs="$(CBTNuGetAllProjects);$(CBTNuGetRestoreFile)"
    Outputs="$(CBTNuGetPackagesRestoredMarker)">

    <NuGetRestore
      File="$(CBTNuGetRestoreFile)"
      RequireConsent="$(CBTNuGetRestoreRequireConsent)"
      PackagesDirectory="$(CBTNuGetRestorePackagesDirectory)"
      SolutionDirectory="$(NuGetRestoreSolutionDirectory)"
      MsBuildVersion="$(NuGetMsBuildVersion)"
      DisableParallelProcessing="$(CBTNuGetDisableParallelProcessing)"
      FallbackSource="$(NuGetFallbackSource)"
      NoCache="$(CBTNuGetNoCache)"
      PackageSaveMode="$(NuGetPackageSaveMode)"
      Source="$(NuGetSource)"
      ConfigFile="$(NuGetConfigFile)"
      NonInteractive="$(CBTNuGetNonInteractive)"
      Verbosity="$(NuGetVerbosity)"
      Timeout="$(CBTNuGetTimeout)"
      ToolPath="$(CBTNuGetPath)"
      />

    <MakeDir Directories="$([System.IO.Path]::GetDirectoryName($(CBTNuGetPackagesRestoredMarker)))" Condition=" '$(CBTEnableNuGetPackageRestoreOptimization)' != 'false' " />

    <Touch AlwaysCreate="true" ForceTouch="true" Files="$(CBTNuGetPackagesRestoredMarker)" Condition=" '$(CBTEnableNuGetPackageRestoreOptimization)' != 'false' " />

    <CallTarget Targets="_CheckForCBTNuGetPackagesRestoredMarker" />

    <PropertyGroup Condition=" '$(CBTNuGetGeneratePackageProperties)' == 'true' And '$(IsRestoreOnly)' == 'true' ">
      <CBTNuGetPackagePropertiesCreated>$(CBTNuGetTasksAssemblyPath.GetType().Assembly.GetType('System.AppDomain').GetProperty('CurrentDomain').GetValue(null).CreateInstanceFromAndUnwrap($(CBTNuGetTasksAssemblyPath), 'CBT.NuGet.Tasks.NuGetRestore').GenerateNuGetProperties($(CBTNuGetRestoreFile), $(CBTNuGetAllProjects.Split(';')), $(CBTNuGetPackagePropertyFile), $(CBTNuGetPackagePropertyVersionNamePrefix), $(CBTNuGetPackagePropertyPathNamePrefix), $(CBTNuGetPackagePropertyPathValuePrefix)))"</CBTNuGetPackagePropertiesCreated>
    </PropertyGroup>

  </Target>

  <Target Name="_CheckForCBTNuGetPackagesRestoredMarker">

    <ItemGroup>
      <FileWrites Include="$(CBTNuGetPackagesRestoredMarker)" Condition=" '$(CBTEnableNuGetPackageRestoreOptimization)' != 'false' And Exists('$(CBTNuGetPackagesRestoredMarker)') " />
    </ItemGroup>

  </Target>

</Project>