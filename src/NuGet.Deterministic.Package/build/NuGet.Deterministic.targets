<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(NuGetDeterministicTasksAssemblyPath)" TaskName="GenerateLockedPackageConfigurationFile" />

  <PropertyGroup>
    <NuGetDeterministicExcludeExplicitPackages Condition="'$(NuGetDeterministicExcludeExplicitPackages)'==''">true</NuGetDeterministicExcludeExplicitPackages>
    <GenerateNuGetDeterministicProps Condition=" '$(GenerateNuGetDeterministicProps)' == '' And '$(NuGetDeterministicPropsWasImported)' != 'true' And '$(ImportNuGetDeterministicProps)' != 'true' ">true</GenerateNuGetDeterministicProps>
    <PrepareForBuildDependsOn Condition=" '$(GenerateNuGetDeterministicProps)' == 'true' ">$(PrepareForBuildDependsOn);GenerateNuGetDeterministicProps</PrepareForBuildDependsOn>
    <PrepareForBuildDependsOn Condition=" '$(NuGetDeterministicPropsWasImported)' == 'true' Or '$(ImportNuGetDeterministicProps)' == 'true' ">$(PrepareForBuildDependsOn);ValidateNuGetDeterministic</PrepareForBuildDependsOn>
  </PropertyGroup>

  <Target Name="GenerateNuGetDeterministicStaticExcludeList">
    <ItemGroup>
      <NuGetDeterministicPackagesToExcludeFromStaticGraph Include="%(PackageReference.Identity)" Condition="'$(NuGetDeterministicExcludeExplicitPackages)'=='true' And '%(PackageReference.IsImplicitlyDefined)' == 'true'"/>
    </ItemGroup>
  </Target>

  <Target Name="GenerateNuGetDeterministicProps"
          Condition=" Exists('$(ProjectAssetsFile)') "
          Inputs="$(ProjectAssetsFile)"
          Outputs="$(NuGetDeterministicGeneratedOutputPropsFile)"
          DependsOnTargets="GenerateNuGetDeterministicStaticExcludeList">
    
    <GenerateLockedPackageConfigurationFile 
      GeneratedOutputPropsFile="$(NuGetDeterministicGeneratedOutputPropsFile)" 
      NuGetAssetsFilePath="$(ProjectAssetsFile)"
      OverWritePropsFile="$(NuGetDeterministicOverWritePropsFile)"
      PackagesToExclude="@(NuGetDeterministicPackagesToExcludeFromStaticGraph)"
      />
    
  </Target>

  <!-- Only analyze PackageReference items that are generated by this deterministic process. -->
  <Target Name="ValidateNuGetPackageHash" Inputs="%(PackageReference.sha512)" Outputs="bogus" Condition=" '$(NuGetDeterministicValidatePackageHash)' == 'true' " >
    <PropertyGroup>
      <_ValidateNuGetPackagePath>%(PackageReference.Path)</_ValidateNuGetPackagePath>
      <_ValidateNuGetPackagePath>$(_ValidateNuGetPackagePath.Replace('/','\'))</_ValidateNuGetPackagePath>
    </PropertyGroup>
    <ItemGroup>
      <_NuGetPackageFoldersToValidatetmp Include="$(NuGetPackageFolders)" />
      <_NuGetPackageFoldersToValidate Include="@(_NuGetPackageFoldersToValidatetmp->'%(identity)\$(_ValidateNuGetPackagePath)')" />
    </ItemGroup>
    <PropertyGroup>
      <_ValidateNuGetPackageHash_NuGetPackagePath Condition = "Exists('%(_NuGetPackageFoldersToValidate.Identity)')" >%(_NuGetPackageFoldersToValidate.Identity)</_ValidateNuGetPackageHash_NuGetPackagePath>
      <_ValidateNuGetPackageHash_NuGetHashFile>$([System.IO.Path]::Combine('$(_ValidateNuGetPackageHash_NuGetPackagePath)','%(PackageReference.hashFileName)'))</_ValidateNuGetPackageHash_NuGetHashFile>
    </PropertyGroup>

    <Error Text="nuget hash file does not exist. $(_ValidateNuGetPackageHash_NuGetHashFile)" Condition = "!Exists('$(_ValidateNuGetPackageHash_NuGetHashFile)')"/>
    <ReadLinesFromFile
      File="$(_ValidateNuGetPackageHash_NuGetHashFile)" >
      <Output TaskParameter="Lines" PropertyName="_ValidateNuGetPackageHash_HashFromFile"/>
    </ReadLinesFromFile>
    <Error Text="%(PackageReference.Path) Expected Hash '%(PackageReference.sha512)' does not match hash of nuget package '$(_ValidateNuGetPackageHash_HashFromFile)'" Condition = " '%(PackageReference.sha512)' != '$(_ValidateNuGetPackageHash_HashFromFile)' " />
  </Target>

  <Target Name="ValidateNuGetPackageIsDeterministic" Condition=" '$(NuGetDeterministicValidatePackageIsDeterministic)' == 'true' " DependsOnTargets="GenerateNuGetDeterministicStaticExcludeList">
    <ItemGroup>
      <_DeterministicPackages Include="%(PackageReference.Identity)" Condition=" '%(PackageReference.sha512)' != '' "/>
      <_DeterministicPackages Include="@(NuGetDeterministicPackagesToExcludeFromStaticGraph)" />
      <_NonDeterministicPackages Include="@(PackageReference)" Exclude="@(_DeterministicPackages)"/>
    </ItemGroup>
    <Error Text="non-Deterministic package reference was found '%(_NonDeterministicPackages.Identity)'.  Ensure '$(NuGetDeterministicGeneratedOutputPropsFile)' contains this package with an explicit version.  Building with GenerateNuGetDeterministicProps set to true should resolve this problem." Condition=" '%(_NonDeterministicPackages.Identity)' != '' "/>
  </Target>

  <Target Name="ValidatePropsIsImported" Condition=" '$(NuGetDeterministicValidatePropsIsImported)' == 'true' ">
    <Error Text="The msbuild property ImportNuGetDeterministicProps must be set to true when '$(NuGetDeterministicGeneratedOutputPropsFile)' is supposed to be imported.  This is to ensure this conditional import is always correct and if not a build error will be generated."
           Condition=" '$(NuGetDeterministicPropsWasImported)' == 'true' And '$(ImportNuGetDeterministicProps)' != 'true' " />

    <Error Text=" '$(NuGetDeterministicGeneratedOutputPropsFile)' was not imported and this project contains &lt;PackageReference Items.  Ensure this file has been generated and checked in.  See NuGet.Deterministic NuGet package for more details." 
           Condition=" '@(PackageReference)' != '' And '$(NuGetDeterministicPropsWasImported)' != 'true' And '$(ImportNuGetDeterministicProps)' == 'true' "/>
  </Target>

  <Target Name="ValidateNuGetDeterministic" DependsOnTargets="$(ValidateNuGetDeterministicDependsOn)"/>

</Project>
