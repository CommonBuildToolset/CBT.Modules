<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(NuGetDeterministicTasksAssemblyPath)" TaskName="NuGet.Tasks.Deterministic" />

  <PropertyGroup>
    <PrepareForBuildDependsOn Condition=" '$(GenerateNuGetDeterministicProps)' == 'true' ">$(PrepareForBuildDependsOn);GenerateNuGetDeterministicProps</PrepareForBuildDependsOn>
    <PrepareForBuildDependsOn Condition=" '$(ImportedNuGetDeterministicProps)' == 'true' ">$(PrepareForBuildDependsOn);ValidateNuGetDeterministic</PrepareForBuildDependsOn>
  </PropertyGroup>

  <Target Name="GenerateNuGetDeterministicProps" Condition=" Exists('$(ProjectAssetsFile)') " Inputs="$(ProjectAssetsFile)" Outputs="$(NuGetDeterministicGeneratedOutputPropsFile)" >
    <MakeDir Directories="$([System.IO.Path]::GetDirectoryName($(NuGetDeterministicGeneratedOutputPropsFile)))"/>
    <NuGet.Tasks.Deterministic GeneratedOutputPropsFile="$(NuGetDeterministicGeneratedOutputPropsFile)" NuGetAssetsFilePath="$(ProjectAssetsFile)" OverWritePropsFile="$(NuGetDeterministicOverWritePropsFile)" />
  </Target>

  <!-- Only analyze PackageReference items that are generated by this deterministic process. -->
  <Target Name="ValidateNuGetPackageHash" Inputs="%(PackageReference.sha512)" Outputs="bogus" Condition=" '$(NuGetDeterministicValidatePackageHash)' == 'true' " >
    <PropertyGroup>
      <_ValidateNuGetPackageHash_NuGetHashFile>$([System.IO.Path]::Combine('%(PackageReference.packageDirectory)','%(PackageReference.hashFileName)'))</_ValidateNuGetPackageHash_NuGetHashFile>
    </PropertyGroup>
    <Error Text="nuget hash file does not exist. $(_ValidateNuGetPackageHash_NuGetHashFile)" Condition = "!Exists('$(_ValidateNuGetPackageHash_NuGetHashFile)')"/>
    <ReadLinesFromFile
            File="$(_ValidateNuGetPackageHash_NuGetHashFile)" >  
            <Output TaskParameter="Lines" PropertyName="_ValidateNuGetPackageHash_HashFromFile"/>  
        </ReadLinesFromFile>  
    <Error Text="%(PackageReference.Path) Expected Hash '%(PackageReference.sha512)' does not match hash of nuget package '$(_ValidateNuGetPackageHash_HashFromFile)'" Condition = " '%(PackageReference.sha512)' != '$(_ValidateNuGetPackageHash_HashFromFile)' " />
  </Target>

  <Target Name="ValidateNuGetPackageIsDeterministic" Condition=" '$(NuGetDeterministicValidatePackageIsDeterministic)' == 'true' " >
    <ItemGroup>
      <_DeterministicPackages Include="%(PackageReference.Identity)" Condition=" '%(PackageReference.sha512)' != '' "/>
      <_NonDeterministicPackages Include="@(PackageReference)" Exclude="@(_DeterministicPackages)"/>
    </ItemGroup>
    <Error Text="non-Deterministic package reference was found '%(_NonDeterministicPackages.Identity)'.  Ensure '$(NuGetDeterministicGeneratedOutputPropsFile)' contains this package with an explicit version.  Building with GenerateNuGetDeterministicProps set to true should resolve this problem." Condition=" '%(_NonDeterministicPackages.Identity)' != '' "/>
  </Target>

  <Target Name="ValidateNuGetDeterministic" DependsOnTargets="$(ValidateNuGetDeterministicDependsOn)"/>

</Project>
